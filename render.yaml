services:
  # Auth User Service (Laravel)
  - type: web
    name: auth-user-service
    env: php
    rootDir: auth-user-service
    buildCommand: composer install --no-dev --no-scripts --no-autoloader && composer dump-autoload --optimize && php artisan migrate --force
    startCommand: php artisan serve --host=0.0.0.0 --port=$PORT
    envVars:
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        sync: false
      - key: DB_PORT
        sync: false
      - key: DB_DATABASE
        sync: false
      - key: DB_USERNAME
        sync: false
      - key: DB_PASSWORD
        sync: false
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: APP_KEY
        sync: false
    healthCheckPath: /api/health

  # Content Service (Node.js)
  - type: web
    name: content-service
    env: node
    rootDir: content-service
    buildCommand: npm install --production
    startCommand: npm start
    envVars:
      - key: PORT
        value: "3001"
      - key: MONGO_URL
        sync: false
    healthCheckPath: /health

  # Comment Service (Node.js)
  - type: web
    name: comment-service
    env: node
    rootDir: comment-service
    buildCommand: npm install --production
    startCommand: npm start
    envVars:
      - key: PORT
        value: "4000"
      - key: MONGO_URL
        sync: false
    healthCheckPath: /health

  # API Gateway (Node.js)
  - type: web
    name: api-gateway
    env: node
    rootDir: api-gateway
    buildCommand: npm install --production
    startCommand: npm start
    envVars:
      - key: PORT
        value: "8080"
      - key: AUTH_SERVICE_URL
        value: https://auth-user-service.onrender.com
      - key: CONTENT_SERVICE_URL
        value: https://content-service.onrender.com
      - key: COMMENT_SERVICE_URL
        value: https://comment-service.onrender.com
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"
    healthCheckPath: /health
